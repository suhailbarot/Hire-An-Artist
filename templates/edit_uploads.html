{% extends 'root/base.html' %}
{% load static %}
    {% load bootstrap %}
    {% block page_title %}Add A Listing{% endblock %}
    {% block header_block %}

<script src="{% static 'jcrop/js/jquery.min.js' %}"></script>
<script src="{% static 'jcrop/js/jquery.Jcrop.min.js' %}"></script>
<link rel="stylesheet" href="{% static 'jcrop/css/jquery.Jcrop.css' %}" type="text/css" />
<script src="{%  static 'js/jquery-ui.min.js' %}" type="text/javascript"></script>

<script type="text/javascript">

$(document).ready(function(){
function readURL(input) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();
            reader.onload = function (e) {
                var JcropAPI = $('.crop').data('Jcrop');
                if(JcropAPI)
                    JcropAPI.destroy();
                $('#blah').css('width','');
                $('#blah').css('height','');
                $('#blah').attr('src', e.target.result);
                jc = $('.crop').Jcrop({
                  onSelect: updateCoords,
                        bgOpacity:   .4,
                        setSelect:   [ 100, 100, 200, 200 ],
                        aspectRatio: 1/1
                });
            };
            reader.readAsDataURL(input.files[0]);
        }
    }
    $("#id_profile_pic").change(function(){
        readURL(this);
    });
    $('#btnCrop').click(function () {
        var x1 = $('#id_x').val();
        var y1 = $('#id_y').val();
        var width = $('#id_x2').val();
        var height = $('#id_y2').val();
        var canvas = $("#canvas")[0];
        var context = canvas.getContext('2d');
        var img = new Image();
        img.onload = function () {
            canvas.height = height;
            canvas.width = width;
            context.drawImage(img, x1, y1, width, height, 0, 0, width, height);
            $('#imgCropped').val(canvas.toDataURL());
        };
        img.src = $('#blah').attr("src");
    });
  function updateCoords(c)
  {
    var img2 = new Image();
        img2.src = $('#blah').attr("src");
        var realwidth = img2.width;
        var realheight = img2.height;
        var imgheight = $('#blah').height();
        var imgwidth = $("#blah").width();
        var fx = realwidth/imgwidth;
        var fy = realheight/imgheight;
    $('#id_x').val(parseInt(c.x*fx));
    $('#id_y').val(parseInt(c.y*fy));
    $('#id_x2').val(parseInt(c.w*fx));
    $('#id_y2').val(parseInt(c.h*fy));
    $('#btnCrop').click();

  };
});

</script>

    {% endblock %}

    {% block body_block %}

        <div class="container form-wizard">
      <div class="add-listing-message">
              <h3>Edit uploads for {{ listing.name }}</h3>
            <hr class="message-separator">
      </div>


        <div class="col-md-8 col-md-offset-2">

        <div class="row">

        <div class="col-md-6">
            <div class="section-container">
                <div class="section-header">
                    <h1>Profile Picture</h1>
                </div>
                <hr class="section-separator">
                <div class="row">
                    <div class="col-md-12">
                        {% if listing.profile_pic %} <img src ="{{ listing.profile_pic.url }}" class="profile_thumb"> {% else %}
                        None
                        {% endif %}
                    </div>
                    <div class="col-md-12">
                        <label>Current Profile Picture</label>
                        <div><a href="#" data-toggle="modal" data-target="#profile_modal">Edit</a></div>
                    </div>
            </div>
        </div>
        </div>

        <div class="col-md-6">
            <div class="section-container">
                <div class="section-header">
                    <h1>Additional Details File</h1>
                </div>
                <hr class="section-separator">
                <div class="row">
                    <div class="col-md-12">
                        {% if listing.tech_details_file %} <a href="{{ listing.tech_details_file.url }}">Link</a> {% else %}
                        None
                        {% endif %}
                    </div>
                    <div class="col-md-12">
                        <label>Current File</label>
                        <div><a href="#" data-toggle="modal" data-target="#additional_modal">Edit</a></div>
                    </div>
            </div>
        </div>
            </div>
        </div>
        </div>

        <div class="col-md-10 col-md-offset-1">
            <div class="section-container">
                <div class="section-header">
                    <h1>Media</h1>
                </div>
                <hr class="section-separator">
                <div class="row">
            </div>
        </div>
        </div>

        </div>




{#                    <div class="col-md-12">#}
{##}
{#                        {{ form.profile_pic | bootstrap }}#}
{#                </div>#}



{#                        <h3>Crop it</h3>#}
{##}
{#                        <table>#}
{#    <tr>#}
{#        <td>#}
{#<img id="blah" class="crop" />#}
{#        </td>#}
{#        <td>#}
{#            <canvas id="canvas" height="5" width="5"></canvas>#}
{#        </td>#}
{#    </tr>#}
{#</table>#}
{#<br>#}
{##}
{#<input type="button" id="btnCrop" type="hidden" style="display: none"/>#}
{#<input type="hidden" name="imgCropped" id="imgCropped" />#}


{% endblock %}


{% block modals %}

    <div class="modal fade" id="profile_modal" tabindex="-1" role="dialog" aria-labelledby="profile_modal">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel">Edit Profile Picture</h4>
      </div>
      <div class="modal-body">
        <div class="row">
            <div class="col-md-8">
                <label>Original</label>
                    <img id="blah" class="crop" style="max-height: 400px; max-width: 500px; min-height: 0; min-width: 0;"/>
<input type="button" id="btnCrop" type="hidden" style="display: none"/>
<input type="hidden" name="imgCropped" id="imgCropped" style="display: none"/>
            </div>
            <div class="col-md-4">
                <div><label>Cropped</label></div>
            <canvas id="canvas"></canvas>

            </div>
            <div class="col-md-6"><div class="up_form"> {{ pf |bootstrap }}</div></div>
        </div>

      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" name="profile_pic_form" value="profile_pic_form" type="submit">Save</button>
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
            </form>
    </div>
  </div>
</div>




    <div class="modal fade" id="additional_modal" tabindex="-1" role="dialog" aria-labelledby="additional_modal">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel">Change the file</h4>
      </div>
      <div class="modal-body">
        <div class="row">
            <div class="col-md-6"><div class="up_form"> {{ af |bootstrap }}</div></div>
        </div>

      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" name="additional_form" value="additional_form" type="submit">Save</button>
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
            </form>
    </div>
  </div>
</div>


{% endblock %}